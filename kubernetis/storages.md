#  Використання сховищ в кластері кубернетіс
Дискові сховища в клстері представлені об'єктами **PV** (Persistent Volume). Кожен такий об'єкт являє собойю "диск" для сберігання, варто відзначити, що PV не прив'язані до простраств імен. Для того, щоб задіяти такий ресурс необхідно використати інший об'єкт, що називається **PVC** (persistent volume claim) та являє собою запит на використання дискового ресурсу. Важливо відмітити, що запит задіює ресурс повністю і не може відкусити від нього кусок (в разі якщо диск не підтримує диамічне виділення розміру). Тобто якщо Ви створите дисковий ресурс PV певного розміру, а потім запит меншого розміру, то кластер виділить під вас запит наявний диск повністю (незважаючи на те, що весь простір не планується використати). Хоча під час обробки запиту кластер буде намагатися підібрати такий дисковий ресурс з наявних, щоб він як найкраще задовольнив запит.
Дискове сховище PV може бути створено через опис заданий в форматі YAML, наприклад, наведемо опис дискового ресурсу:
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv0005
spec:
  capacity:
   storage: 5Gi
  volumeMode: Filesystem
  accessModes:
   - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  storageClassName: slow
  mountOptions:
   - hard
   - nfsvers=4.1
  nfs:
   path: /tmp
   server: 172.17.0.2
```
Важливо відзначити, кілька основних елементів: _kind: PersistentVolume_ - задає тип об'єкту який необхідно створити, _storage: 5Gi_ - задає розмір дискового ресурсу, _accessModes_ - задає тип доступу до ресурсу, а  _persistentVolumeReclaimPolicy_ - задає політику дій при видаленні диску коли він більше не потрібен.

## Мета та переваги постійних томів
Постійні томи призначені для вирішення проблем керування зберіганням даних у кластері Kubernetes. Забезпечуючи рівень абстракції зберігання, PV дозволяють безперешкодно керувати сховищем, забезпечуючи при цьому збереження даних. Ця абстракція дозволяє розробникам і операторам зосередитися на логіці програми, а не турбуватися про базову інфраструктуру зберігання.

Однією з ключових переваг використання постійних томів є їх здатність відокремлювати сховище від окремих подів. Це відокремлення забезпечує більшу гнучкість у управлінні пакетами, оскільки дані, що зберігаються в постійному томі, залишаються недоторканими, навіть якщо под видалено або переплановано. Крім того, постійні томи підтримують різні режими доступу, дозволяючи кільком подам читати та записувати дані одночасно.

Коли йдеться про зберігання даних у кластері Kubernetes, постійні томи відіграють вирішальну роль. Вони діють як міст між програмами, що працюють у подах, і основною інфраструктурою зберігання. Абстрагуючись від складнощів керування сховищами, PV спрощують розгортання та масштабування додатків, полегшуючи розробникам зосередження на своїх основних завданнях.

Крім того, постійні томи забезпечують надійне та послідовне рішення для зберігання. Дані, що зберігаються в PV, не прив’язані до конкретного поду, тобто, навіть якщо под виходить з ладу або його перенесено, дані залишаються доступними. Це забезпечує цілісність даних і високу доступність, критичну для додатків, які потребують постійного зберігання.
## Особливості постійних томів
Кожен PV містить специфікацію (специфікацію) і статус тому. У цьому розділі описуються специфікаційні атрибути файлу конфігурації PV з посиланням на приклад файлу конфігурації YAML, наведений вище.

### Ємність
Як правило, PV визначає ємність зберігання. Це встановлюється за допомогою властивості capacity в описі PV. Наразі capacity  властивості задають лище ємность як єдиний ресурс, який можна встановити або запросити. У майбутньому він може включати такі атрибути, як IOPS, пропускна здатність тощо.

### Режими предтавлення даних
Kubernetes підтримує два режими постійних томів: файлова система _Filesystem_ 
 та блочний пристрій _Block_. Файлова система є режимом за замовчуванням, якщо режим доступу не визначено. Фактично визначає режим роботи з сховищем, або як з файловою системою, або як з пристроєм, що складається з блоків.

### Режими доступу
* **ReadOnlyMany**(ROX) дозволяє монтувати кілька вузлів у режимі лише для читання.
* **ReadWriteOnce**(RWO) дозволяє монтувати один вузол у режимі читання-запису.
* **ReadWriteMany**(RWX) дозволяє монтувати кілька вузлів у режимі читання-запису.

Том можна монтувати лише за допомогою одного режиму доступу за раз, навіть якщо він підтримує багато режимів доступу. Тобто можна задати, що том може буде використаний в різних варіантах редиму доступу, проте він буде фактично підключений в одному єдиному режимі з доступних в залежності від запиту.

### Клас
PV може вказати StorageClass для динамічного зв’язування PV і PVC, де певний StorageClass вказується за допомогою властивості storageClassName. Якщо з цією властивістю не вказано жодного PV, він може прив’язуватися лише до PVC, якому не потрібен певний клас. Фактично StorageClass - це ще одинрівень абстракції, що дозволяє об'єднати томи за певною класифікацією. Наприклад в нас є різні фізичні пристрої на основі SSD та HDD, одні швидкі інші надійніші. В такому випадку ми можемо створити два класи та виділяти тома помічаючи їх відповідним класом, і в залежності від задач, робити запити або на швидкі диски, або на більш надійніші.

### Політика повернення
Коли вузол більше не потребує постійного сховища, стратегії відновлення, які можна використовувати, включають:
* **Retain** Зберігати – це означає, що PV залишається активним до видалення.
* **Recycle** Переробити – це означає, що дані можна відновити пізніше після очищення.
* **Delete** Видалити – пов’язані ресурси зберігання (наприклад, томи AWS EBS, GCE PD, Azure Disk і OpenStack Cinder) видаляються.

Наразі лише NFS і hostPath підтримують політику Recycle. Томи AWS EBS, GCE PD, Azure Disk і Cinder підтримують політику видалення.

### Параметри монтування
Адміністратори Kubernetes можуть указати параметри монтування для монтування постійних томів на вузлі. Не всі типи PV підтримують опції підключення.
Лище вказані типи підримують параметри підключення:
* gcePersistentDisk
* awsElasticBlockStore
* AzureDisk
* NFS
* RBD (блоковий пристрій Rados)
* CephFS
* Cinder (томне сховище OpenStack)
* Glusterfs

Фактично тут можуть зазначатися додаткові параметри необхідіні, щоб підключитися до пристрою, наприклад адреса серверу, логін та пароль, мережеві параметри і т.п.

## Запит на сховище PVC
PVC — це декларація, що визначає запит на використання даних зберігання, яка монтується в Pod для використання. PVC налаштований для використання розробниками, які не обов’язково піклуються про конкретну реалізацію базового сховища даних, а більше про розмір сховища, пов’язаний з бізнесом, методи доступу тощо.

Ось файл конфігурації для PersistentVolumeClaim:
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pv0004
spec:
  storageClassName: manual
  accessModes:
   - ReadWriteOnce
  resources:
   requests:
    storage: 3Gi
```
Для таких типів дискових ресурсів, можливо динамічне розширення дикового простору:
* gcePersistentDisk
* awsElasticBlockStore
* Cinder
* Glusterfs
* RBD
* Azure File
* Azure Disk
* Portworx
* FlexVolumes
* CSI

Проте тут важливу роль відіграє наявність опції allowVolumeExpansion в описі Storage class:
```
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: pv0003
provisioner: kubernetes.io/glusterfs
parameters:
  resturl: “http://192.168.10.100:8080”
  restuser: “”
  secretNamespace: “”
  secretName: “”
allowVolumeExpansion: true
```
Нажаль іншими типами пристроїв, розширити том можливості немає, лише шляхом видалення та створення нового. І а такому шляху Вас може спідкати багато складношів, пов'язаних з необхідністю розірвати зв'язок PV <- PVC <-Pod.

## Життєвий цикл PV та PVC
У кластері Kubernetes PV існує як ресурс зберігання в кластері. PVC є запитами на ці ресурси, а також виконують функцію перевірки претензій до ресурсу. Взаємодія між PV і PVC відповідає такому життєвому циклу:
* **Provisioning**  Надання — створення PV безпосередньо (статично) або динамічно за допомогою StorageClass.
* **Binding** Прив'язка - присвоєння ПВ ПВХ.
* **Using** Використання - стручки використовують об'єм через ПВХ.
* **Reclaiming** Відновлення – PV відновлюється, зберігаючи його для наступного використання або видаляючи безпосередньо з хмарного сховища.
  
Том буде в одному з таких станів:
* **Available** Доступно - цей стан показує, що PV готовий до використання PVC.
* **Bound** Прив’язаний – цей стан показує, що PV було призначено PVC.
* **Released** Випущено – претензію видалено, але кластер ще не відновив ресурс.
* **Failed** - цей стан показує, що в PV сталася помилка.

