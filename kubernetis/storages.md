#  Використання сховищ в кластері кубернетіс
Дискові сховища в клстері представлені об'єктами **PV** (Persistent Volume). Кожен такий об'єкт являє собойю "диск" для сберігання, варто відзначити, що PV не прив'язані до простраств імен. Для того, щоб задіяти такий ресурс необхідно використати інший об'єкт, що називається **PVC** (persistent volume claim) та являє собою запит на використання дискового ресурсу. Важливо відмітити, що запит задіює ресурс повністю і не може відкусити від нього кусок (в разі якщо диск не підтримує диамічне виділення розміру). Тобто якщо Ви створите дисковий ресурс PV певного розміру, а потім запит меншого розміру, то кластер виділить під вас запит наявний диск повністю (незважаючи на те, що весь простір не планується використати). Хоча під час обробки запиту кластер буде намагатися підібрати такий дисковий ресурс з наявних, щоб він як найкраще задовольнив запит.
Дискове сховище PV може бути створено через опис заданий в форматі YAML, наприклад, наведемо опис дискового ресурсу:
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv0005
spec:
  capacity:
   storage: 5Gi
  volumeMode: Filesystem
  accessModes:
   - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  storageClassName: slow
  mountOptions:
   - hard
   - nfsvers=4.1
  nfs:
   path: /tmp
   server: 172.17.0.2
```
Важливо відзначити, кілька основних елементів: _kind: PersistentVolume_ - задає тип об'єкту який необхідно створити, _storage: 5Gi_ - задає розмір дискового ресурсу, _accessModes_ - задає тип доступу до ресурсу, а  _persistentVolumeReclaimPolicy_ - задає політику дій при видаленні диску коли він більше не потрібен.

## Мета та переваги постійних томів
Постійні томи призначені для вирішення проблем керування зберіганням даних у кластері Kubernetes. Забезпечуючи рівень абстракції зберігання, PV дозволяють безперешкодно керувати сховищем, забезпечуючи при цьому збереження даних. Ця абстракція дозволяє розробникам і операторам зосередитися на логіці програми, а не турбуватися про базову інфраструктуру зберігання.

Однією з ключових переваг використання постійних томів є їх здатність відокремлювати сховище від окремих подів. Це відокремлення забезпечує більшу гнучкість у управлінні пакетами, оскільки дані, що зберігаються в постійному томі, залишаються недоторканими, навіть якщо под видалено або переплановано. Крім того, постійні томи підтримують різні режими доступу, дозволяючи кільком подам читати та записувати дані одночасно.

Коли йдеться про зберігання даних у кластері Kubernetes, постійні томи відіграють вирішальну роль. Вони діють як міст між програмами, що працюють у подах, і основною інфраструктурою зберігання. Абстрагуючись від складнощів керування сховищами, PV спрощують розгортання та масштабування додатків, полегшуючи розробникам зосередження на своїх основних завданнях.

Крім того, постійні томи забезпечують надійне та послідовне рішення для зберігання. Дані, що зберігаються в PV, не прив’язані до конкретного поду, тобто, навіть якщо под виходить з ладу або його перенесено, дані залишаються доступними. Це забезпечує цілісність даних і високу доступність, критичну для додатків, які потребують постійного зберігання.
## Особливості постійних томів
Кожен PV містить специфікацію (специфікацію) і статус тому. У цьому розділі описуються специфікаційні атрибути файлу конфігурації PV з посиланням на приклад файлу конфігурації YAML, наведений вище.

### Ємність
Як правило, PV визначає ємність зберігання. Це встановлюється за допомогою властивості capacity в описі PV. Наразі capacity  властивості задають лище ємность як єдиний ресурс, який можна встановити або запросити. У майбутньому він може включати такі атрибути, як IOPS, пропускна здатність тощо.

### Режими предтавлення даних
Kubernetes підтримує два режими постійних томів: файлова система _Filesystem_ 
 та блочний пристрій _Block_. Файлова система є режимом за замовчуванням, якщо режим доступу не визначено. Фактично визначає режим роботи з сховищем, або як з файловою системою, або як з пристроєм, що складається з блоків.

### Режими доступу
* **ReadOnlyMany**(ROX) дозволяє монтувати кілька вузлів у режимі лише для читання.
* **ReadWriteOnce**(RWO) дозволяє монтувати один вузол у режимі читання-запису.
* **ReadWriteMany**(RWX) дозволяє монтувати кілька вузлів у режимі читання-запису.

Том можна монтувати лише за допомогою одного режиму доступу за раз, навіть якщо він підтримує багато режимів доступу. Тобто можна задати, що том може буде використаний в різних варіантах редиму доступу, проте він буде фактично підключений в одному єдиному режимі з доступних в залежності від запиту.

### Клас
PV може вказати StorageClass для динамічного зв’язування PV і PVC, де певний StorageClass вказується за допомогою властивості storageClassName. Якщо з цією властивістю не вказано жодного PV, він може прив’язуватися лише до PVC, якому не потрібен певний клас. Фактично StorageClass - це ще одинрівень абстракції, що дозволяє об'єднати томи за певною класифікацією. Наприклад в нас є різні фізичні пристрої на основі SSD та HDD, одні швидкі інші надійніші. В такому випадку ми можемо створити два класи та виділяти тома помічаючи їх відповідним класом, і в залежності від задач, робити запити або на швидкі диски, або на більш надійніші.

### Політика повернення
Коли вузол більше не потребує постійного сховища, стратегії відновлення, які можна використовувати, включають:
* **Retain** Зберігати – це означає, що PV залишається активним до видалення.
* **Recycle** Переробити – це означає, що дані можна відновити пізніше після очищення.
* **Delete** Видалити – пов’язані ресурси зберігання (наприклад, томи AWS EBS, GCE PD, Azure Disk і OpenStack Cinder) видаляються.

Наразі лише NFS і hostPath підтримують політику Recycle. Томи AWS EBS, GCE PD, Azure Disk і Cinder підтримують політику видалення.

### Параметри монтування
Адміністратори Kubernetes можуть указати параметри монтування для монтування постійних томів на вузлі. Не всі типи PV підтримують опції підключення.
Лище вказані типи підримують параметри підключення:
* gcePersistentDisk
* awsElasticBlockStore
* AzureDisk
* NFS
* RBD (блоковий пристрій Rados)
* CephFS
* Cinder (томне сховище OpenStack)
* Glusterfs

Фактично тут можуть зазначатися додаткові параметри необхідіні, щоб підключитися до пристрою, наприклад адреса серверу, логін та пароль, мережеві параметри і т.п.

## Запит на сховище PVC
PVC — це декларація, що визначає запит на використання даних зберігання, яка монтується в Pod для використання. PVC налаштований для використання розробниками, які не обов’язково піклуються про конкретну реалізацію базового сховища даних, а більше про розмір сховища, пов’язаний з бізнесом, методи доступу тощо.

Ось файл конфігурації для PersistentVolumeClaim:
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pv0004
spec:
  storageClassName: manual
  accessModes:
   - ReadWriteOnce
  resources:
   requests:
    storage: 3Gi
```
Для таких типів дискових ресурсів, можливо динамічне розширення дикового простору:
* gcePersistentDisk
* awsElasticBlockStore
* Cinder
* Glusterfs
* RBD
* Azure File
* Azure Disk
* Portworx
* FlexVolumes
* CSI

Проте тут важливу роль відіграє наявність опції allowVolumeExpansion в описі Storage class:
```
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: pv0003
provisioner: kubernetes.io/glusterfs
parameters:
  resturl: “http://192.168.10.100:8080”
  restuser: “”
  secretNamespace: “”
  secretName: “”
allowVolumeExpansion: true
```
Нажаль іншими типами пристроїв, розширити том можливості немає, лише шляхом видалення та створення нового. І а такому шляху Вас може спідкати багато складношів, пов'язаних з необхідністю розірвати зв'язок PV <- PVC <-Pod.

## Життєвий цикл PV та PVC
У кластері Kubernetes PV існує як ресурс зберігання в кластері. PVC є запитами на ці ресурси, а також виконують функцію перевірки претензій до ресурсу. Взаємодія між PV і PVC відповідає такому життєвому циклу:
* **Provisioning**  Надання — створення PV безпосередньо (статично) або динамічно за допомогою StorageClass.
* **Binding** Прив'язка - присвоєння ПВ ПВХ.
* **Using** Використання - стручки використовують об'єм через ПВХ.
* **Reclaiming** Відновлення – PV відновлюється, зберігаючи його для наступного використання або видаляючи безпосередньо з хмарного сховища.
  
Том буде в одному з таких станів:
* **Available** Доступно - цей стан показує, що PV готовий до використання PVC.
* **Bound** Прив’язаний – цей стан показує, що PV було призначено PVC.
* **Released** Випущено – претензію видалено, але кластер ще не відновив ресурс.
* **Failed** - цей стан показує, що в PV сталася помилка.

### Надання томів
Існує два способи надання томів постійного сховища в Kubernetes:

#### Статичний
PV створюються адміністраторами кластера Kubernetes і існують в Kubernetes API. PV представляють реальне сховище, і ці сховища, надані PV, доступні для всіх користувачів у кластері. При статичному забезпеченні PV створюється заздалегідь адміністратором кластера; розробник створює PVC і Pod, а Pod використовує сховище, надане PV через PVC.

#### Динамічний
Для динамічного надання, коли жоден зі статичних PV, створених адміністратором, не може відповідати PVC користувача, кластер намагатиметься автоматично надати обсяг зберігання для PVC, який базується на StorageClass. У напрямку динамічного надання PVC має запитувати клас зберігання, але цей клас зберігання має бути попередньо створений і налаштований адміністратором. Адміністратор кластера повинен увімкнути контролер доступу для DefaultStorageClass на сервері API.

### Прив'язка томів
Користувач створює PVC (або створив раніше для динамічного надання), вказуючи необхідний розмір сховища та режим доступу. Кластер виконує моніторинг нових PVC, пошук відповідних PV (якщо такі є) і зв’язування PVC і PV разом. Якщо PV колись динамічно підключається до нового PVC, цикл завжди прив’язуватиме цей PV до PVC. Крім того, користувачі завжди отримають принаймні необхідну кількість пам’яті, але обсяг може перевищувати їх запит. 

Якщо відповідний PV не знайдено, PVC залишатиметься незв’язаним на невизначений час, коли PV стане доступним, PVC знову стане зв’язаним. Наприклад, якщо кластеру надано багато PV 50G, він не відповідатиме запитаним PVCs 100G, і PVC не буде зв’язано, доки до кластера не буде додано PV 100G.

### Використання
Pod використовує PVC як об’єм, а кластер Kubernetes шукає пов’язану PV за PVC і монтує його до Pod. Користувач може вказати спосіб доступу при використанні PVC як обсягу. Для томів, які підтримують множинні методи доступу, користувач визначає, який режим бажаний, коли використовує свою вимогу як том у поді. Якщо користувач має зв’язаний PVC, зв’язаний PV належить цьому користувачеві. Користувач може отримати доступ до PV, яким володіє, через PVC, що міститься в пам’яті Pod.

### Відновлення
Коли користувач закінчить роботу зі своїм томом, він може видалити об’єкти PVC з API, що дозволяє відновити ресурс. Політика повернення для PersistentVolume повідомляє кластеру, що робити з томом після того, як його претензію було звільнено. Наразі томи можна зберегти або видалити.

### Зберегти
Політика Retain reclaim дозволяє ручне відновлення ресурсу. Коли PVC видалено, PV все ще існує, а том вважається «вивільненим». Однак він ще не доступний для іншої претензії, оскільки дані попереднього заявника залишаються на томі.

### Видалити
Для плагінів сховища, які підтримують політику повернення, видалення видаляє PV з Kubernetes. Крім того, він видаляє сховище із пов’язаної зовнішньої інфраструктури, як-от томів сховища AWS EBS, GCE PD, Azure Disk або Cinder.

## Загальні випадки використання
Одним із поширених випадків використання постійних томів є керування базами даних. Бази даних часто вимагають постійного зберігання для підтримки цілісності даних і забезпечення високої доступності. Використовуючи постійний том, адміністратори можуть гарантувати, що дані, що зберігаються в базі даних, залишаються постійними, навіть якщо відповідний модуль переходить у режим роботи або його розклад перенесено.

Іншим варіантом використання постійних томів є програми для обміну файлами та співпраці. Такі програми, як системи керування вмістом або файлові сервери, часто вимагають спільного сховища, де кілька модулів можуть читати та записувати дані одночасно. Постійні томи забезпечують необхідну функціональність для задоволення цих вимог.

Окрім баз даних і програм для обміну файлами, постійні томи також можуть бути корисними в інших сценаріях. Наприклад, у додатках машинного навчання, де великі набори даних потрібно зберігати та отримувати доступ кільком модулям одночасно, PV пропонують масштабоване та ефективне рішення. Подібним чином у розгортаннях IoT, де дані датчиків потрібно постійно збирати та зберігати, постійні томи можуть забезпечити надійність і доступність даних.

Загалом, постійні томи є потужним інструментом в екосистемі Kubernetes. Вони забезпечують гнучкий і надійний спосіб керування зберіганням даних, відокремлюючи їх від окремих модулів і забезпечуючи плавне масштабування та керування програмами. Розуміючи призначення та переваги постійних томів, розробники та оператори можуть приймати обґрунтовані рішення про те, коли та як використовувати цю технологію у своїх програмах.

Тепер подивіться на кілька прикладів, щоб дізнатися про типові випадки використання.

### Приклад 1:
Наведений нижче файл конфігурації описує розгортання MySQL в одному екземплярі. Контейнер MySQL монтує PV у /var/lib/mysql. Змінна середовища MYSQL_ROOT_PASSWORD встановлює пароль бази даних із Secret.

```
apiVersion: v1
kind: Service
metadata:
  name: wordpress-mysql
  labels:
    app: wordpress
spec:
  ports:
    - port: 3306
  selector:
    app: wordpress
    tier: mysql
  clusterIP: None
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: wordpress
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-mysql
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: mysql
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pv-claim
```

### приклад 2:
У наведеному нижче файлі конфігурації описано одноразове розгортання WordPress. Контейнер WordPress монтує PV у /var/www/html для файлів даних веб-сайту. Змінна середовища WORDPRESS_DB_HOST встановлює назву служби MySQL, визначену вище, і WordPress буде звертатися до бази даних через службу. Змінна середовища WORDPRESS_DB_PASSWORD встановлює пароль бази даних із створеного Secret kustomize.
```
apiVersion: v1
kind: Service
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  ports:
    - port: 80
  selector:
    app: wordpress
    tier: frontend
  type: LoadBalancer
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wp-pv-claim
  labels:
    app: wordpress
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: frontend
    spec:
      containers:
      - image: wordpress:4.8-apache
        name: wordpress
        env:
        - name: WORDPRESS_DB_HOST
          value: wordpress-mysql
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        ports:
        - containerPort: 80
          name: wordpress
        volumeMounts:
        - name: wordpress-persistent-storage
          mountPath: /var/www/html
      volumes:
      - name: wordpress-persistent-storage
        persistentVolumeClaim:
          claimName: wp-pv-claim
```

### приклад 3:
Наведений нижче файл конфігурації описує PVC, який запитує необроблений блочний том.
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: block-pvc
spec:
  accessModes:
   - ReadWriteOnce
  volumeMode: Block
  resources:
   requests:
    storage: 10Gi
```
### Приклад 4:
У наступному файлі конфігурації описано створення PVC із знімка тома.
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: restore-pvc
spec:
  storageClassName: csi-hostpath-sc
  dataSource:
   name: new-snapshot-test
   kind: VolumeSnapshot
   apiGroup: snapshot.storage.k8s.io
  accessModes:
   - ReadWriteOnce
  resources:
   requests:
    storage: 10Gi
```

### Приклад 5:
У наведеному нижче файлі конфігурації описано створення PersistentVolumeClaim із існуючого PVC.
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cloned-pvc
spec:
  storageClassName: my-csi-plugin
  dataSource:
   name: existing-src-pvc-name
   kind: PersistentVolumeClaim
  accessModes:
   - ReadWriteOnce
  resources:
   requests:
    storage: 10Gi
```

## Кращі практики
Під час налаштування PV документація Kubernetes рекомендує пам’ятати про набір найкращих практик:

Щоб зменшити витрати на керування та ввімкнути масштабування, уникайте статичного створення та призначення постійних томів. Натомість використовуйте динамічне надання. У вашому класі сховища визначте відповідну політику повернення, щоб мінімізувати витрати на сховище після видалення модулів.

Максимальна кількість розмірів підтримується кожним вузлом; отже, різні розміри вузлів забезпечують різні обсяги локального зберігання та ємності. Плануйте відповідно до вимог вашої програми, щоб розгорнути правильний розмір вузлів.

Життєвий цикл постійного тому (PV) не залежить від будь-якого конкретного контейнера в кластері. Заявки на постійний обсяг (PVC) – це запит, зроблений користувачем контейнера або додатком для певного типу сховища. Під час створення PV документація Kubernetes рекомендує наступне:

* Завжди включайте PVC у конфігурацію контейнера.
* Ніколи не включайте PV до конфігурації контейнера, оскільки це щільно зв’яже контейнер із певним об’ємом.
* Завжди мати клас зберігання за замовчуванням; інакше PVC, які не вказують на конкретний клас, не вдасться.
* Дайте StorageClasses осмислені імена.

### Дослідження різниці між томами Kubernetes і постійними томами
У Kubernetes томи — це, по суті, тимчасові каталоги, які можна монтувати за допомогою контейнерів у Pod. Однак після завершення роботи Pod дані, що зберігаються в томах, втрачаються. Навпаки, постійні томи надають засоби для відокремлення сховища від Pod, забезпечуючи збереження даних навіть тоді, коли Pod видаляється.

Крім того, постійні томи в Kubernetes пропонують підтримку різних технологій зберігання, включаючи локальне сховище, мережеве сховище (NAS) і хмарні платформи зберігання. Ця гнучкість гарантує, що розробники можуть задовольнити свої специфічні вимоги до сховища, не прив’язуючись до одного рішення.

Що стосується томів Kubernetes, вони тісно пов’язані з життєвим циклом модуля. Це означає, що коли модуль припиняється або перепланується, дані, що зберігаються в його томах, втрачаються. Це обмеження може бути проблематичним для додатків, які вимагають збереження даних, таких як бази даних або системи зберігання файлів.

З іншого боку, постійні томи забезпечують вирішення цієї проблеми шляхом відокремлення сховища від модулів. Це означає, що навіть якщо модуль припинено або переплановано, дані, що зберігаються в постійному томі, залишаються недоторканими. Це відокремлення забезпечує постійність даних і гарантує, що програми можуть покладатися на свої дані навіть у разі збоїв чи змін модулів.

Крім того, Persistent Volumes пропонують підтримку різних технологій зберігання, надаючи розробникам гнучкість у виборі найбільш підходящого варіанту для їхніх конкретних потреб. Незалежно від того, чи це локальне сховище для високопродуктивних додатків, мережеве сховище (NAS) для спільного доступу або хмарні платформи для масштабування, постійні томи Kubernetes можуть задовольнити широкий спектр вимог до сховища.

Загалом, постійні томи дають змогу розробникам створювати масштабовані та стійкі додатки в Kubernetes із гарантією того, що їхні дані зберігатимуться протягом життєвих циклів модулів.

## Висновок
Постійне сховище Kubernetes пропонує програмам Kubernetes зручний спосіб запитувати та споживати ресурси сховища. PVC і PV еквівалентні об'єктно-орієнтованим інтерфейсам і реалізаціям. Под, створений користувачем, оголошує PVC, і Kubernetes знайде PV для його з’єднання. Якщо PV для створення пари немає, перейдіть до відповідного StorageClass, допоможіть йому створити PV, а потім завершіть зв’язування з PVC. Щойно створеному PV потрібно створити віддалений диск для хоста через приєднаний головний вузол, а потім підключити підключений віддалений диск до каталогу хоста через компонент kubelet кожного вузла.

PV ідеально підходять, якщо у вас є дані, якими потрібно ділитися між модулями або які повинні витримати перезавантаження. PV можна визначити та прив’язати до конкретного Pod, і, отже, тепер ви також можете запускати керовані даними програми на Kubernetes.
